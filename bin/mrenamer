#!/bin/zsh

typeset -A conv_table

generate_convert_table(){
    for i in {000..025}; do
        if [[ ${i} != "000" ]]; then
            num=$(sed "s/^0*//" <<< $i)
            if [[ ${num} -lt 10 ]]; then
                conv_table[2$i]="2x${num}"
            else
                j=0
                for q in {A..Z}; do
                    if [[ $j == $num ]]; then
                        conv_table[2$i]="2x${q}"
                    fi
                    ((j++))
                done
            fi
        else
            conv_table[2000]="2x0"
        fi
    done
}

debug_print_convert_table(){
    {for key in "${(@k)conv_table}"; do
        builtin print "${key} -> ${conv_table[${key}]}" 
    done}|sort -h
}

apply_rename(){
    data=$(albumdetails "$@")

    artist=$(builtin print "${data}"|grep "Artist"| cut -d ':' -f 2-|xargs)
    year=$(builtin print "${data}"|grep "Year"| cut -d ':' -f 2-|xargs)

    for i in {0..9}; do
        year=${year//99$i/x$i}
    done

    generate_convert_table
    debug_print_convert_table

    year=${year//$year/$conv_table[$year]}

    album=$(builtin print "${data}"|grep "Album"| cut -d ':' -f 2-|xargs)

    result="$(dirname "${src}")/$(builtin print "${artist}-[${year}]-${album}")"
    src=$(builtin print "$(dirname $1)")
    mv -vi "${src}" "${result}"
    fix_names.pl -i "${result}"
    rmdir "${src}" 2> /dev/null
}

main(){
    case "$1" in
        "current")
            autoload -U zargs
            dirname="$(awk '/music_directory/{print $2}' /etc/mpd.conf|tr -d '"')/$(dirname "$(mpc -f '%file%'|head -1)")"
            cd "${dirname}"
            builtin print "Apply rename to :: [${dirname}] contents ::"
            zargs -- ${dirname}/** -- apply_rename 
        ;;
        "files")
            shift
            apply_rename "$@"
        ;;
    esac
}

main "$@"
