#!/bin/zsh

# Script to run windows 10 with geforce 980gtx gpu ;)

function main(){

    local disk_name="w10"
    local iso_path="/home/neg/1st_level/iso"
    local win10_iso="en_windows_10_education_version_1607_updated_jul_2016_x64_dvd_9055880.iso"
    local win_iso="${win10_iso}"

    local -a qemu_params=(
        -enable-kvm
        -m 8192
        -smp sockets=1,cores=4,threads=2
        -cpu host,kvm=off
        -device virtio-scsi-pci,id=scsi
        -drive if=pflash,format=raw,readonly,file=/one/vm/ovmf_code_x64.bin
        -drive if=pflash,format=raw,file=/one/vm/ovmf_vars_x64.bin
        -drive file="/one/vm/${disk_name}.qcow2",id=disk,format=qcow2,if=none,cache=writeback -device scsi-hd,drive=disk
    )

    local -a qemu_cpu_norm_params=(
        -cpu host,kvm=off,hv_time,hv_relaxed,hv_vapic,hv_spinlocks=0x1fff
    )

    local -a qemu_cpu_slow_params=(
        -cpu host,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_time,hv-vendor-id=servo,hv-vpindex,hv-reset,hv-runtime,hv-crash
    )

    local -a qemu_rtc_params=(
        -rtc base=utc,driftfix=slew -no-hpet -global kvm-pit.lost_tick_policy=discard
    )

    local -a qemu_source_params=(
        -drive file="${iso_path}/${win_iso},index=0,media=cdrom"
        -drive file="${iso_path}/virtio-win-0.1.137.iso,index=1,media=cdrom"
        -boot menu=on
    )

    local -a qemu_pass_video=(
        -vga none
        -device vfio-pci,host=01:00.0,multifunction=on
        -device vfio-pci,host=01:00.1
    )

    local -a qemu_pass_input=(
        -usb
        -usbdevice host:1e7d:2e22 # Roccat kone rtd [ Mouse ]
        -usbdevice host:046d:c32b # Logitech G910 [Keyboard]
    )

    local -a qemu_usb_host=(
        -device ich9-usb-uhci3,id=uhci
        -device usb-ehci,id=ehci
        -device nec-usb-xhci,id=xhci
    )

    local -a qemu_emulated_sound=(
        -soundhw ac97
    )

    local -a qemu_share=(
        -net nic -net user,smb=/mnt/qemu 
    )

    local -a qemu_separated_console=(
        -qmp unix:/home/neg/1st_level/qmp.socket,server --monitor stdio \
        /home/neg/bin/scripts/qmp/qmp-shell /home/neg/1st_level/qmp.socket
    )

    local -a qemu_network=(
        -net nic -net tap,ifname=tap0,script=/home/neg/bin/qemu/qemu-ifup,downscript=/home/neg/bin/qemu/qemu-ifdown
    )

    if [[ ! $(pidof synergyc) ]]; then
        sudo -u neg "synergy" & print "Autostart synergy"
    fi

    QEMU_AUDIO_TIMER_PERIOD=150 \
    QEMU_PA_SAMPLES=1024 \
    QEMU_PA_SERVER=localhost \
    PULSE_SERVER=localhost \
    QEMU_AUDIO_DRV=pa \
    qemu-system-x86_64 "${qemu_params[@]}" \
        "${qemu_emulated_sound[@]}" \
        "${qemu_source_params[@]}" \
        "${qemu_pass_video[@]}" \
        "${qemu_pass_input[@]}"  \
        "${qemu_network[@]}"
}

main "$@"
