#!/bin/zsh

# Script to run windows 10 with geforce 980gtx gpu ;)

function main(){
    local disk_name="w10"
    local win10_iso="/home/neg/1st_level/iso/en_windows_10_education_version_1607_updated_jul_2016_x64_dvd_9055880.iso"
    local virtio_iso="/home/neg/1st_level/iso/virtio-win-0.1.137.iso"
    local smb_path="/mnt/qemu"
    local qmp_socket_path="/home/neg/1st_level/qmp.socket"
    local qmp_sh_script="/home/neg/bin/scripts/qmp/qmp-shell"
    local install_iso="${win10_iso}"

    local -a qemu_params=(
        -enable-kvm
        -m 8192
        -smp sockets=1,cores=4,threads=2
        -cpu host,kvm=off
        -device virtio-scsi-pci,id=scsi
        -drive if=pflash,format=raw,readonly,file=/one/vm/ovmf_code_x64.bin
        -drive if=pflash,format=raw,file=/one/vm/ovmf_vars_x64.bin
        -drive file="/one/vm/${disk_name}.qcow2",id=disk,format=qcow2,if=none,cache=writeback -device scsi-hd,drive=disk
    )

    local -a qemu_source_params=(
        -drive file="${install_iso},index=0,media=cdrom"
        -drive file="${virtio_iso},index=1,media=cdrom"
        -boot menu=on
    )

    local -a qemu_pass_video=(
        -vga none
        -device vfio-pci,host=01:00.0,multifunction=on
        -device vfio-pci,host=01:00.1
    )

    local -a qemu_pass_input=(
        -usb
        -usbdevice host:1e7d:2e22 # Roccat kone rtd [ Mouse ]
        -usbdevice host:046d:c32b # Logitech G910 [Keyboard]
    )

    local -a qemu_emulated_sound=(
        -soundhw ac97
    )

    local -a qemu_share=(
        -net nic -net user,smb="${smb_path}"
    )

    local -a qemu_separated_console=(
        -qmp unix:"${qmp_socket_path}",server --monitor stdio \
        "${qmp_sh_script}" "${qmp_socket_path}"
    )

    local -a qemu_network=(
        -net nic -net tap,ifname=tap0,script=/home/neg/bin/qemu/qemu-ifup,downscript=/home/neg/bin/qemu/qemu-ifdown
    )

    if [[ ! $(pidof synergyc) ]]; then
        sudo -u neg "synergy" & print "Autostart synergy"
    fi

    QEMU_AUDIO_TIMER_PERIOD=150 \
    QEMU_PA_SAMPLES=1024 \
    QEMU_PA_SERVER=localhost \
    PULSE_SERVER=localhost \
    QEMU_AUDIO_DRV=pa \
    qemu-system-x86_64 "${qemu_params[@]}" \
        "${qemu_emulated_sound[@]}" \
        "${qemu_source_params[@]}" \
        "${qemu_pass_video[@]}" \
        "${qemu_pass_input[@]}"  \
        "${qemu_network[@]}"
}

main "$@"
