#!/bin/bash

die() { echo "${0##*/}: $*" >&2; exit 1; }

[[ -f $CLOJURE_JAR ]] || CLOJURE_JAR=/usr/share/java/clojure.jar 
[[ -f $CLOJURE_JAR ]] || CLOJURE_JAR=$HOME/skel/clojure/clojure.jar
[[ -f $CLOJURE_JAR ]] || die "can't find clojure.jar"

[[ -f $CLOJURE_CONTRIB_JAR ]] || CLOJURE_CONTRIB_JAR=${CLOJURE_JAR%/*}/clojure-contrib.jar
[[ -f $CLOJURE_CONTRIB_JAR ]] || CLOJURE_CONTRIB_JAR=$HOME/skel/clojure/clojure-contrib.jar
[[ -f $CLOJURE_CONTRIB_JAR ]] || unset CLOJURE_CONTRIB_JAR

CLASSPATH="$CLOJURE_JAR${CLOJURE_CONTRIB_JAR:+:$CLOJURE_CONTRIB_JAR}:/usr/share/java/*${CLASSPATH:+:$CLASSPATH}"
export CLASSPATH

if [[ -z $1 ]]; then
    if type -p rlwrap &>/dev/null; then
        mkdir -p ~/.clojure
        touch ~/.clojure/rlwrap-{completions,history}
        rlwrap \
            --remember --break-chars "\"\\'(){}[],^%$#@;:|" \
            --complete-filenames \
            --file ~/.clojure/rlwrap-history \
            --file ~/.clojure/rlwrap-completions \
            --history-filename ~/.clojure/rlwrap-history \
            java clojure.lang.Repl
    else
        java clojure.lang.Repl
    fi
elif [[ -f $1 ]]; then
    java clojure.lang.Script "$@"
else
    java "$@"
fi
