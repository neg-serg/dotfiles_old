#!/bin/zsh

. ${XDG_CONFIG_HOME}/.wallpapers
. ~/.zsh/03-helpers.zsh

local wall_dir="${HOME}/pic/wl"
local prev_list="${HOME}/tmp/current_walls"
local trash_dir="${HOME}/tmp/trash"

local last_count=40

function save_current_wall(){
    echo "$1" > ${HOME}/tmp/current_wallpaper
}

function print_wall(){
    print $(_zpref) $(_zfwrap "${1}")
}

function main(){
    current=$(< ${HOME}/tmp/current_wallpaper|head -1)
    case ${1} in
        "set") 
            local -a filtered_wall_=()
            for i in ${wall_}; [[ -e "$i" ]] && filtered_wall_+=(${i})
            current="${wall_[$[RANDOM % $#filtered_wall_]+1]}"
            hsetroot -full "${current}" && save_current_wall "${current}" &
            ;;
        "rand")
            local -a walls=(${wall_dir}/*.{jpg,png})
            local current="${walls[$[RANDOM % $#walls]+1]}"
            {
                print "${current}" >> "${prev_list}" && \
                local buf=$(tail -${last_count} "${prev_list}")
                echo "${buf}" > "${prev_list}"
            } &
            hsetroot -full "${current}" && save_current_wall "${current}" &
            ;;
        "del")
            [[ ! -d ${trash_dir} ]] && mkdir "${trash_dir}"
            mv -iv "$(tail -1 ${prev_list})" "${trash_dir}"
            ;;
        l*)
            while IFS='' read -r line; do
                print $(_zpref) $(_zfwrap "${line}")
            done < "${prev_list}"
            ;;
        (curr|pr)*)
            print_wall "${current}"
            ;;
    esac
}

main "$@"
