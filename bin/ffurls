#!/usr/bin/env ruby

require 'json'

def read_session
  f = Dir[File.expand_path('~/.mozilla/firefox/*.default/sessionstore.js')].first
  f or abort "#{$0}: sessionstore.js not found"
  JSON.load(File.read(f))
end

def puturls(tabs)
  tabs.each do |tab|
    puts tab['entries'][tab['index']-1]['url']
  end
end

def read_window
  session = read_session()
  session['windows'][session['selectedWindow']-1]
end

case ARGV[0]
when nil, 'all'
  read_session['windows'].each { |window| puturls window['tabs'] }
when 'window'
  puturls read_window
when 'group'
  window = read_window()
  group  = JSON.parse(window['extData']['tabview-groups'])['activeGroupId']
  tabs   = window['tabs'].find_all do |tab|
    JSON.parse(tab['extData']['tabview-tab'])['groupID'] == group
  end
  puturls tabs
when 'tab'
  window = read_window()
  tab    = window['tabs'][window['selected']-1]
  page   = tab['entries'][tab['index']-1]
  puts page['url']
end
